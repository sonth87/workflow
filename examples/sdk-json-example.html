<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BPM Core SDK - JSON Configuration Example</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          Cantarell, sans-serif;
      }
      #bpm-container {
        width: 100vw;
        height: 100vh;
      }
      .info-panel {
        position: fixed;
        bottom: 10px;
        left: 10px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        max-width: 300px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }
      .info-panel h3 {
        margin: 0 0 10px 0;
        font-size: 14px;
      }
      .info-panel p {
        margin: 5px 0;
        font-size: 12px;
        color: #666;
      }
      .event-log {
        margin-top: 10px;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
        font-size: 11px;
        font-family: monospace;
      }
      .event-log div {
        margin: 2px 0;
        padding: 2px 0;
        border-bottom: 1px solid #ddd;
      }
      .info-panel.minimized #panel-content {
        display: none;
      }
      .info-panel.minimized h3 {
        margin-bottom: 0;
        font-size: 14px;
      }
      .info-panel.minimized {
        bottom: 0px;
        left: 0px;
        padding: 2px 8px;
      }
      #minimize-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 24px;
        line-height: 24px;
        float: right;
        color: #666;
        font-weight: bold;
      }
      #language-select {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1001;
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div id="bpm-container"></div>

    <div class="info-panel">
      <h3>JSON Configuration Active <button id="minimize-btn">-</button></h3>
      <div id="panel-content">
        <p>Custom nodes loaded from JSON:</p>
        <ul
          id="loaded-nodes"
          style="font-size: 11px; margin: 5px 0; padding-left: 20px"
        ></ul>
        <div class="event-log" id="event-log">
          <strong>Event Log:</strong>
        </div>
      </div>
    </div>

    <select id="language-select">
      <option value="en">English</option>
      <option value="vi">Tiếng Việt</option>
      <option value="ko">한국어 (Korean)</option>
    </select>

    <!-- Load BPM SDK -->
    <script src="../sdk-dist/bpm-sdk.js?v=1768973826232"></script>

    <script>
      // Inline translations for file:// protocol (when opened directly)
      // Flat format - one object per language
      const enTranslations = {
        "toolbar.selectTool": "Select tool (V)",
        "toolbar.handTool": "Hand tool (H) - Pan canvas only",
        "toolbar.zoomOut": "Zoom out",
        "toolbar.zoomIn": "Zoom in",
        "toolbar.resetView": "Reset view",
        "toolbar.fullscreen": "Fullscreen",
        "toolbar.moreOptions": "More options",
        "toolbar.options": "Options",
        "toolbar.minimap": "Minimap",
        "toolbox.toolbox": "Toolbox",
        "toolbox.expandToolbox": "Expand toolbox",
        "toolbox.minimizeToolbox": "Minimize toolbox",
        "toolbox.collapseToolbox": "Collapse toolbox",
        "properties.nodeProperties": "Node Properties",
        "properties.edgeProperties": "Edge Properties",
        "contextMenu.resetColor": "Reset Color",
        "contextMenu.changeColor": "Change Color",
        "contextMenu.delete": "Delete",
        "contextMenu.properties": "Properties",
        "sendEmailTask.name": "Send Email",
        "sendEmailTask.description": "Send email notification",
        "sendEmailTask.properties.to.label": "To",
        "sendEmailTask.properties.to.placeholder": "email@example.com",
        "sendEmailTask.properties.subject.label": "Subject",
        "sendEmailTask.properties.body.label": "Body",
        "sendEmailTask.contextMenu.testEmail": "Send Test Email",
        "httpRequestTask.name": "HTTP Request",
        "httpRequestTask.description": "Make HTTP/REST API calls",
        "httpRequestTask.properties.url.label": "URL",
        "httpRequestTask.properties.url.placeholder": "https://api.example.com",
        "httpRequestTask.properties.method.label": "Method",
        "httpRequestTask.contextMenu.testRequest": "Test Request",
        "conditionalStart.name": "Conditional Start",
        "conditionalStart.description": "Start with condition",
        "conditionalStart.properties.condition.label": "Condition",
        "conditionalStart.properties.condition.placeholder":
          "variable === 'value'",
        "simpleTask.name": "Simple Task",
        "simpleTask.description": "Task with minimal context menu",
        "simpleTask.contextMenu.markComplete": "Mark Complete",
        "lockedTask.name": "Locked Task",
        "lockedTask.description": "Task with no duplicate/delete",
        "lockedTask.contextMenu.unlock": "Unlock Task",
        "minimalTask.name": "Minimal Task",
        "minimalTask.description": "Task with only custom menu",
        "minimalTask.contextMenu.execute": "Execute Task",
        "minimalTask.contextMenu.configure": "Configure",
      };

      const viTranslations = {
        "toolbar.selectTool": "Công cụ chọn",
        "toolbar.handTool": "Công cụ cầm nắm - Chỉ di chuyển canvas",
        "toolbar.zoomOut": "Thu nhỏ",
        "toolbar.zoomIn": "Phóng to",
        "toolbar.resetView": "Đặt lại chế độ xem",
        "toolbar.fullscreen": "Toàn màn hình",
        "toolbar.moreOptions": "Thêm tùy chọn",
        "toolbar.options": "Tùy chọn",
        "toolbar.minimap": "Bản đồ thu nhỏ",
        "toolbox.toolbox": "Hộp công cụ",
        "toolbox.expandToolbox": "Mở rộng hộp công cụ",
        "toolbox.minimizeToolbox": "Thu nhỏ hộp công cụ",
        "toolbox.collapseToolbox": "Đóng hộp công cụ",
        "properties.nodeProperties": "Thuộc tính nút",
        "properties.edgeProperties": "Thuộc tính cạnh",
        "contextMenu.resetColor": "Đặt lại màu",
        "contextMenu.changeColor": "Đổi màu",
        "contextMenu.delete": "Xóa",
        "contextMenu.properties": "Thuộc tính",
        "sendEmailTask.name": "Gửi Email",
        "sendEmailTask.description": "Gửi thông báo email",
        "sendEmailTask.properties.to.label": "Gửi tới",
        "sendEmailTask.properties.to.placeholder": "email@example.com",
        "sendEmailTask.properties.subject.label": "Chủ đề",
        "sendEmailTask.properties.body.label": "Nội dung",
        "sendEmailTask.contextMenu.testEmail": "Gửi Email Test",
        "httpRequestTask.name": "Yêu cầu HTTP",
        "httpRequestTask.description": "Thực hiện gọi HTTP/REST API",
        "httpRequestTask.properties.url.label": "URL",
        "httpRequestTask.properties.url.placeholder": "https://api.example.com",
        "httpRequestTask.properties.method.label": "Phương thức",
        "httpRequestTask.contextMenu.testRequest": "Kiểm tra Yêu cầu",
        "conditionalStart.name": "Bắt đầu Điều kiện",
        "conditionalStart.description": "Bắt đầu với điều kiện",
        "conditionalStart.properties.condition.label": "Điều kiện",
        "conditionalStart.properties.condition.placeholder":
          "variable === 'value'",
        "simpleTask.name": "Nhiệm vụ Đơn giản",
        "simpleTask.description": "Nhiệm vụ với menu ngữ cảnh tối thiểu",
        "simpleTask.contextMenu.markComplete": "Đánh dấu Hoàn thành",
        "lockedTask.name": "Nhiệm vụ Khóa",
        "lockedTask.description": "Nhiệm vụ không sao chép/xóa",
        "lockedTask.contextMenu.unlock": "Mở Khóa Nhiệm vụ",
        "minimalTask.name": "Nhiệm vụ Tối thiểu",
        "minimalTask.description": "Nhiệm vụ chỉ với menu tùy chỉnh",
        "minimalTask.contextMenu.execute": "Thực thi Nhiệm vụ",
        "minimalTask.contextMenu.configure": "Cấu hình",
      };

      const koTranslations = {
        "toolbar.selectTool": "선택 도구 (V)",
        "toolbar.handTool": "손 도구 (H) - 캔버스만 이동",
        "toolbar.zoomOut": "축소",
        "toolbar.zoomIn": "확대",
        "toolbar.resetView": "보기 재설정",
        "toolbar.fullscreen": "전체 화면",
        "toolbar.moreOptions": "더 많은 옵션",
        "toolbar.options": "옵션",
        "toolbar.minimap": "미니맵",
        "toolbox.toolbox": "도구 상자",
        "toolbox.expandToolbox": "도구 상자 확장",
        "toolbox.minimizeToolbox": "도구 상자 최소화",
        "toolbox.collapseToolbox": "도구 상자 축소",
        "properties.nodeProperties": "노드 속성",
        "properties.edgeProperties": "엣지 속성",
        "contextMenu.resetColor": "색상 재설정",
        "contextMenu.changeColor": "색상 변경",
        "contextMenu.delete": "삭제",
        "contextMenu.properties": "속성",
        "sendEmailTask.name": "이메일 전송",
        "sendEmailTask.description": "이메일 알림 발송",
        "sendEmailTask.properties.to.label": "받는 사람",
        "sendEmailTask.properties.to.placeholder": "email@example.com",
        "sendEmailTask.properties.subject.label": "제목",
        "sendEmailTask.properties.body.label": "본문",
        "sendEmailTask.contextMenu.testEmail": "테스트 이메일 전송",
        "httpRequestTask.name": "HTTP 요청",
        "httpRequestTask.description": "HTTP/REST API 호출 수행",
        "httpRequestTask.properties.url.label": "URL",
        "httpRequestTask.properties.url.placeholder": "https://api.example.com",
        "httpRequestTask.properties.method.label": "메서드",
        "httpRequestTask.contextMenu.testRequest": "요청 테스트",
        "conditionalStart.name": "조건부 시작",
        "conditionalStart.description": "조건으로 시작",
        "conditionalStart.properties.condition.label": "조건",
        "conditionalStart.properties.condition.placeholder":
          "variable === 'value'",
        "simpleTask.name": "단순 작업",
        "simpleTask.description": "최소 컨텍스트 메뉴가 있는 작업",
        "simpleTask.contextMenu.markComplete": "완료로 표시",
        "lockedTask.name": "잠긴 작업",
        "lockedTask.description": "복제/삭제 없는 작업",
        "lockedTask.contextMenu.unlock": "작업 잠금 해제",
        "minimalTask.name": "최소 작업",
        "minimalTask.description": "맞춤 메뉴만 있는 작업",
        "minimalTask.contextMenu.execute": "작업 실행",
        "minimalTask.contextMenu.configure": "구성",
      };

      // Define custom nodes as JSON with translation keys (flat format)
      // ✅ All translations now loaded from separate JSON files
      const customNodes = [
        {
          id: "sendEmailTask",
          extends: "task",
          name: "sendEmailTask.name", // Translation key
          description: "sendEmailTask.description",
          icon: {
            type: "lucide",
            value: "Mail",
            color: "#ffffff",
            backgroundColor: "#e74c3c",
          },
          visualConfig: {
            backgroundColor: "#fef2f2",
            borderColor: "#ef4444",
            textColor: "#7f1d1d",
          },
          properties: [
            {
              id: "to",
              name: "to",
              label: "sendEmailTask.properties.to.label",
              type: "text",
              required: true,
              placeholder: "sendEmailTask.properties.to.placeholder",
              group: "custom",
              order: 1,
            },
            {
              id: "subject",
              name: "subject",
              label: "sendEmailTask.properties.subject.label",
              type: "text",
              required: true,
              group: "custom",
              order: 2,
            },
            {
              id: "body",
              name: "body",
              label: "sendEmailTask.properties.body.label",
              type: "textarea",
              required: true,
              group: "custom",
              order: 3,
            },
          ],
          contextMenuItems: [
            {
              id: "test-email",
              label: "sendEmailTask.contextMenu.testEmail",
              icon: "Send",
              action: {
                type: "event",
                event: "custom:send-test-email",
              },
            },
          ],
          eventTriggers: [
            {
              on: "node:added",
              action: "emit",
              event: "custom:email-node-created",
              payload: { type: "email" },
            },
          ],
          hooks: {
            onCreated: "custom:sendEmailTask:created",
          },
        },
        {
          id: "httpRequestTask",
          extends: "task",
          name: "httpRequestTask.name",
          description: "httpRequestTask.description",
          icon: {
            type: "lucide",
            value: "Globe",
            color: "#ffffff",
            backgroundColor: "#3b82f6",
          },
          properties: [
            {
              id: "url",
              name: "url",
              label: "httpRequestTask.properties.url.label",
              type: "text",
              required: true,
              placeholder: "httpRequestTask.properties.url.placeholder",
              group: "custom",
              order: 1,
            },
            {
              id: "method",
              name: "method",
              label: "httpRequestTask.properties.method.label",
              type: "select",
              required: true,
              defaultValue: "GET",
              group: "custom",
              order: 2,
              options: [
                { label: "GET", value: "GET" },
                { label: "POST", value: "POST" },
                { label: "PUT", value: "PUT" },
                { label: "DELETE", value: "DELETE" },
              ],
            },
          ],
          contextMenuItems: [
            {
              id: "test-request",
              label: "httpRequestTask.contextMenu.testRequest",
              icon: "Play",
              action: {
                type: "event",
                event: "custom:test-http-request",
              },
            },
          ],
        },
        {
          id: "conditionalStart",
          extends: "start",
          name: "conditionalStart.name",
          description: "conditionalStart.description",
          icon: {
            type: "lucide",
            value: "AlarmClock",
          },
          properties: [
            {
              id: "condition",
              name: "condition",
              label: "conditionalStart.properties.condition.label",
              type: "text",
              required: true,
              placeholder: "conditionalStart.properties.condition.placeholder",
              group: "custom",
            },
          ],
        },
        {
          id: "simpleTask",
          extends: "task",
          name: "simpleTask.name",
          description: "simpleTask.description",
          icon: {
            type: "lucide",
            value: "CheckSquare",
            color: "#ffffff",
            backgroundColor: "#10b981",
          },
          visualConfig: {
            backgroundColor: "#ecfdf5",
            borderColor: "#10b981",
            textColor: "#064e3b",
          },
          // Disable some default context menu items
          disableDefaultContextMenu: ["change-type", "appearance"],
          contextMenuItems: [
            {
              id: "mark-complete",
              label: "simpleTask.contextMenu.markComplete",
              icon: "Check",
              action: {
                type: "event",
                event: "custom:task-complete",
              },
            },
          ],
        },
        {
          id: "lockedTask",
          extends: "task",
          name: "lockedTask.name",
          description: "lockedTask.description",
          icon: {
            type: "lucide",
            value: "Lock",
            color: "#ffffff",
            backgroundColor: "#f59e0b",
          },
          visualConfig: {
            backgroundColor: "#fef3c7",
            borderColor: "#f59e0b",
            textColor: "#78350f",
          },
          // Disable duplicate and delete options
          disableDefaultContextMenu: ["duplicate", "delete"],
          contextMenuItems: [
            {
              id: "unlock",
              label: "lockedTask.contextMenu.unlock",
              icon: "Unlock",
              action: {
                type: "event",
                event: "custom:unlock-task",
              },
            },
          ],
        },
        {
          id: "minimalTask",
          extends: "task",
          name: "minimalTask.name",
          description: "minimalTask.description",
          icon: {
            type: "lucide",
            value: "Minimize",
            color: "#ffffff",
            backgroundColor: "#6366f1",
          },
          visualConfig: {
            backgroundColor: "#eef2ff",
            borderColor: "#6366f1",
            textColor: "#312e81",
          },
          // Disable all default context menu items
          disableDefaultContextMenu: ["all"],
          contextMenuItems: [
            {
              id: "execute",
              label: "minimalTask.contextMenu.execute",
              icon: "Play",
              action: {
                type: "event",
                event: "custom:execute-task",
              },
            },
            {
              id: "configure",
              label: "minimalTask.contextMenu.configure",
              icon: "Settings",
              action: {
                type: "event",
                event: "custom:configure-task",
              },
            },
          ],
        },
      ];
      // Initialize BPM with JSON config
      var bpm = new BPM({
        selector: "#bpm-container",
        options: {
          // Load custom nodes from JSON with translation keys
          customNodes: customNodes,

          // ✅ Pass English translations (default language)
          translations: enTranslations,

          // Set default language
          defaultLanguage: "en",

          ui: {
            mode: "edit",
            showHeader: true,
            showToolbox: true,
            showPropertiesPanel: true,
          },
        },

        onReady: async function (instance) {
          console.log("BPM Core initialized");

          const currentLanguage = bpm.getLanguage();
          console.log("Current language:", currentLanguage);

          // Preload all available translations
          await bpm.loadTranslationsForLanguage("vi", viTranslations);
          await bpm.loadTranslationsForLanguage("ko", koTranslations);
          console.log("All translations preloaded");

          const languageSwitcher = document.getElementById("language-select");
          languageSwitcher.value = currentLanguage;

          // Handle language change - translations already preloaded
          languageSwitcher.addEventListener("change", function (e) {
            const newLang = e.target.value;
            console.log("Switching language to:", newLang);
            bpm.setLanguage(newLang);
          });

          // Update UI with loaded nodes
          const nodesList = document.getElementById("loaded-nodes");
          customNodes.forEach(function (node) {
            const li = document.createElement("li");
            // node.name is now a translation key
            li.textContent =
              node.id + " (uses translation key: " + node.name + ")";
            nodesList.appendChild(li);
          });

          // Subscribe to custom events
          bpm.on("custom:email-node-created", function (event) {
            logEvent("Email node created", event.payload);
          });

          bpm.on("custom:sendEmailTask:created", function (event) {
            logEvent("sendEmailTask hook triggered", event.payload);
          });

          bpm.on("custom:send-test-email", function (event) {
            logEvent("Test email triggered", event.payload);
            alert("Test email would be sent!");
          });

          bpm.on("custom:test-http-request", function (event) {
            logEvent("Test HTTP request triggered", event.payload);
            alert("Test HTTP request would be executed!");
          });

          bpm.on("node:added", function (event) {
            logEvent("Node added to workflow", {
              type: event.payload.node?.type,
            });
          });

          // Additional custom events for new nodes
          bpm.on("custom:task-complete", function (event) {
            logEvent("Task marked complete", event.payload);
            alert("Task completed!");
          });

          bpm.on("custom:unlock-task", function (event) {
            logEvent("Task unlocked", event.payload);
            alert("Task unlocked!");
          });

          bpm.on("custom:execute-task", function (event) {
            logEvent("Execute task", event.payload);
            alert("Task executed!");
          });

          bpm.on("custom:configure-task", function (event) {
            logEvent("Configure task", event.payload);
            alert("Opening configuration...");
          });
        },

        onError: function (error) {
          console.error("BPM initialization error:", error);
          alert("Error: " + error.message);
        },
      });

      // Minimize button functionality
      document
        .getElementById("minimize-btn")
        .addEventListener("click", function () {
          const panel = document.querySelector(".info-panel");
          panel.classList.toggle("minimized");
          this.textContent = panel.classList.contains("minimized") ? "" : "-";
        });

      // Expand panel when clicking on minimized panel (excluding button)
      document
        .querySelector(".info-panel")
        .addEventListener("click", function (event) {
          if (
            event.target.id !== "minimize-btn" &&
            this.classList.contains("minimized")
          ) {
            this.classList.remove("minimized");
            document.getElementById("minimize-btn").textContent = "-";
          }
        });

      // Helper function to log events
      function logEvent(message, data) {
        const logDiv = document.getElementById("event-log");
        const entry = document.createElement("div");
        const time = new Date().toLocaleTimeString();
        entry.textContent = time + " - " + message;
        if (data) {
          entry.textContent += " | " + JSON.stringify(data);
        }
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
      }
    </script>
  </body>
</html>
